apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-logs-collector
  namespace: newsletter
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otel-logs-collector
rules:
  - apiGroups: [""]
    resources: ["pods", "namespaces", "nodes"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-logs-collector
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: otel-logs-collector
subjects:
  - kind: ServiceAccount
    name: otel-logs-collector
    namespace: newsletter
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-logs-collector-config
  namespace: newsletter
data:
  otel-collector-config.yaml: |
    receivers:
      filelog:
        include:
          - /var/log/pods/*/*/*.log
        start_at: beginning
        include_file_path: true
        operators:
          - type: container

    processors:
      k8sattributes:
        auth_type: serviceAccount
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.pod.name
            - k8s.container.name
            - k8s.node.name
      resource:
        attributes:
          - key: service.name
            action: insert
            value: kubernetes-logs
      batch: {}

    exporters:
      otlp/clickstack:
        endpoint: ${env:CLICKSTACK_OTLP_GRPC_ENDPOINT}
        headers:
          authorization: ${env:CLICKSTACK_INGESTION_API_KEY}

    service:
      pipelines:
        logs:
          receivers: [filelog]
          processors: [k8sattributes, resource, batch]
          exporters: [otlp/clickstack]
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: otel-logs-collector
  namespace: newsletter
spec:
  selector:
    matchLabels:
      app: otel-logs-collector
  template:
    metadata:
      labels:
        app: otel-logs-collector
    spec:
      serviceAccountName: otel-logs-collector
      containers:
        - name: otel-collector
          image: otel/opentelemetry-collector-contrib:0.119.0
          imagePullPolicy: IfNotPresent
          args:
            - --config=/conf/otel-collector-config.yaml
          env:
            - name: CLICKSTACK_OTLP_GRPC_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: clickstack-otel
                  key: endpoint
            - name: CLICKSTACK_INGESTION_API_KEY
              valueFrom:
                secretKeyRef:
                  name: clickstack-otel
                  key: api-key
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              memory: 256Mi
          volumeMounts:
            - name: config
              mountPath: /conf
            - name: varlogcontainers
              mountPath: /var/log/containers
              readOnly: true
            - name: varlogpods
              mountPath: /var/log/pods
              readOnly: true
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: otel-logs-collector-config
        - name: varlogcontainers
          hostPath:
            path: /var/log/containers
        - name: varlogpods
          hostPath:
            path: /var/log/pods
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
            type: DirectoryOrCreate
