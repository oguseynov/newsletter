apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-node-collector
  namespace: newsletter
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otel-node-collector
rules:
  - apiGroups: [""]
    resources: ["pods", "namespaces", "nodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["nodes/stats", "nodes/proxy"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-node-collector
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: otel-node-collector
subjects:
  - kind: ServiceAccount
    name: otel-node-collector
    namespace: newsletter
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-node-collector-config
  namespace: newsletter
data:
  otel-collector-config.yaml: |
    receivers:
      filelog:
        include:
          - /var/log/pods/*/*/*.log
        start_at: beginning
        include_file_path: true
        operators:
          - type: container
      hostmetrics:
        collection_interval: 20s
        scrapers:
          cpu: {}
          memory: {}
          disk: {}
          filesystem: {}
          network: {}
          load: {}
      kubeletstats:
        collection_interval: 20s
        auth_type: serviceAccount
        endpoint: ${env:K8S_NODE_NAME}:10250
        insecure_skip_verify: true
        metrics:
          k8s.pod.cpu_limit_utilization:
            enabled: true
          k8s.pod.cpu_request_utilization:
            enabled: true
          k8s.pod.memory_limit_utilization:
            enabled: true
          k8s.pod.memory_request_utilization:
            enabled: true
          k8s.pod.uptime:
            enabled: true
          k8s.node.uptime:
            enabled: true
          k8s.container.cpu_limit_utilization:
            enabled: true
          k8s.container.cpu_request_utilization:
            enabled: true
          k8s.container.memory_limit_utilization:
            enabled: true
          k8s.container.memory_request_utilization:
            enabled: true
          container.uptime:
            enabled: true

    processors:
      k8sattributes:
        auth_type: serviceAccount
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.pod.name
            - k8s.container.name
            - k8s.node.name
      resource:
        attributes:
          - key: service.name
            action: insert
            value: kubernetes-node-collector
      batch: {}

    exporters:
      otlp/clickstack:
        endpoint: ${env:CLICKSTACK_OTLP_GRPC_ENDPOINT}
        headers:
          authorization: ${env:CLICKSTACK_INGESTION_API_KEY}

    service:
      pipelines:
        logs:
          receivers: [filelog]
          processors: [k8sattributes, resource, batch]
          exporters: [otlp/clickstack]
        metrics:
          receivers: [hostmetrics, kubeletstats]
          processors: [k8sattributes, resource, batch]
          exporters: [otlp/clickstack]
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: otel-node-collector
  namespace: newsletter
spec:
  selector:
    matchLabels:
      app: otel-node-collector
  template:
    metadata:
      labels:
        app: otel-node-collector
    spec:
      serviceAccountName: otel-node-collector
      containers:
        - name: otel-collector
          image: otel/opentelemetry-collector-contrib:0.119.0
          imagePullPolicy: IfNotPresent
          args:
            - --feature-gates=receiver.kubeletstats.enableCPUUsageMetrics
            - --config=/conf/otel-collector-config.yaml
          env:
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: CLICKSTACK_OTLP_GRPC_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: clickstack-otel
                  key: endpoint
            - name: CLICKSTACK_INGESTION_API_KEY
              valueFrom:
                secretKeyRef:
                  name: clickstack-otel
                  key: api-key
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 300m
              memory: 256Mi
          volumeMounts:
            - name: config
              mountPath: /conf
            - name: varlogcontainers
              mountPath: /var/log/containers
              readOnly: true
            - name: varlogpods
              mountPath: /var/log/pods
              readOnly: true
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: otel-node-collector-config
        - name: varlogcontainers
          hostPath:
            path: /var/log/containers
        - name: varlogpods
          hostPath:
            path: /var/log/pods
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
            type: DirectoryOrCreate
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-cluster-collector
  namespace: newsletter
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otel-cluster-collector
rules:
  - apiGroups: [""]
    resources:
      [
        "events",
        "namespaces",
        "namespaces/status",
        "nodes",
        "nodes/spec",
        "nodes/stats",
        "pods",
        "pods/status",
        "replicationcontrollers",
        "replicationcontrollers/status",
        "resourcequotas",
        "services",
      ]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["daemonsets", "deployments", "replicasets", "statefulsets"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["batch"]
    resources: ["jobs", "cronjobs"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["extensions"]
    resources: ["daemonsets", "deployments", "replicasets"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-cluster-collector
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: otel-cluster-collector
subjects:
  - kind: ServiceAccount
    name: otel-cluster-collector
    namespace: newsletter
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-cluster-collector-config
  namespace: newsletter
data:
  otel-collector-config.yaml: |
    receivers:
      k8s_cluster:
        auth_type: serviceAccount
        collection_interval: 20s
      k8sobjects:
        objects:
          - name: events
            mode: watch

    processors:
      k8sattributes:
        auth_type: serviceAccount
      transform/k8s_events:
        log_statements:
          - context: log
            statements:
              - set(log.attributes["k8s.event.type"], ExtractPatterns(log.attributes["object"], "\"type\":\"(?P<event_type>[^\"]+)\"")["event_type"]) where log.attributes["object"] != nil
              - set(log.attributes["k8s.event.reason"], ExtractPatterns(log.attributes["object"], "\"reason\":\"(?P<event_reason>[^\"]+)\"")["event_reason"]) where log.attributes["object"] != nil
              - set(log.attributes["type"], log.attributes["k8s.event.type"]) where log.attributes["k8s.event.type"] != nil
              - set(log.body, log.attributes["object"]) where log.attributes["object"] != nil
      resource:
        attributes:
          - key: service.name
            action: insert
            value: kubernetes-cluster-collector
      batch: {}

    exporters:
      otlp/clickstack:
        endpoint: ${env:CLICKSTACK_OTLP_GRPC_ENDPOINT}
        headers:
          authorization: ${env:CLICKSTACK_INGESTION_API_KEY}

    service:
      pipelines:
        logs:
          receivers: [k8sobjects]
          processors: [k8sattributes, transform/k8s_events, resource, batch]
          exporters: [otlp/clickstack]
        metrics:
          receivers: [k8s_cluster]
          processors: [k8sattributes, resource, batch]
          exporters: [otlp/clickstack]
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: otel-cluster-collector
  namespace: newsletter
spec:
  replicas: 1
  selector:
    matchLabels:
      app: otel-cluster-collector
  template:
    metadata:
      labels:
        app: otel-cluster-collector
    spec:
      serviceAccountName: otel-cluster-collector
      containers:
        - name: otel-collector
          image: otel/opentelemetry-collector-contrib:0.119.0
          imagePullPolicy: IfNotPresent
          args:
            - --config=/conf/otel-collector-config.yaml
          env:
            - name: CLICKSTACK_OTLP_GRPC_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: clickstack-otel
                  key: endpoint
            - name: CLICKSTACK_INGESTION_API_KEY
              valueFrom:
                secretKeyRef:
                  name: clickstack-otel
                  key: api-key
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 300m
              memory: 256Mi
          volumeMounts:
            - name: config
              mountPath: /conf
      volumes:
        - name: config
          configMap:
            name: otel-cluster-collector-config
